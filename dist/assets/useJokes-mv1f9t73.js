import{u as y,a as m}from"./useMutation-BSQQP79B.js";import{s as f,n as p}from"./index-CHW_jxOE.js";async function h(e={}){const{status:t="published",categoryId:r=null,limit:a=50,offset:s=0,orderBy:u="created_at",ascending:l=!1}=e,{data:n,error:o}=await f.rpc("get_jokes_with_details",{p_status:t,p_category_id:r,p_limit:a,p_offset:s,p_order_by:u,p_ascending:l});return o?(console.error("Error fetching jokes:",o),[]):(n==null?void 0:n.map(i=>({...i,profiles:i.author_username?{username:i.author_username}:null,categories:i.category_name?{name:i.category_name,slug:i.category_slug}:null})))||[]}async function v(e){if(!e)return null;const{data:t,error:r}=await f.from("jokes").select(`
      id,
      content,
      created_at,
      updated_at,
      upvotes,
      downvotes,
      score,
      status,
      slug,
      author_id,
      category_id,
      categories(name, slug),
      profiles!inner(username)
    `).eq("slug",e).eq("status","published").single();return r?(console.error("Error fetching joke by slug:",r),null):t}const _={jokes:["jokes"],jokesWithPagination:(e,t)=>["jokes","paginated",e,t],joke:e=>["joke",e],categories:["categories"],userVotes:(e,t)=>["votes",e,t],userFavorites:(e,t)=>["favorites",e,t],userAllFavorites:e=>["favorites",e,"all"],searchResults:(e,t)=>["search",e,t]};function k(e={}){const{page:t=0,categoryId:r=null,limit:a=15,orderBy:s="created_at",enabled:u=!0}=e;return y({queryKey:_.jokesWithPagination(t,r),queryFn:async()=>{const l=t*a;let n=f.from("jokes").select("id",{count:"exact",head:!0}).eq("status","published");r&&(n=n.eq("category_id",r));const{count:o}=await n;return{jokes:await h({status:"published",categoryId:r,limit:a,offset:l,orderBy:s,ascending:s!=="created_at"}),totalCount:o||0,totalPages:Math.ceil((o||0)/a)}},enabled:u,staleTime:1e3*60*2})}function j(e,t){return y({queryKey:["joke","slug",e],queryFn:async()=>{if(!e)return null;const r=await v(e);if(!r)throw new Error("Joke not found");return r},enabled:t,staleTime:1e3*60*5})}function F(){return y({queryKey:_.categories,queryFn:async()=>{const{data:e,error:t}=await f.from("categories").select("*").order("name");if(t)throw t;return e},staleTime:1e3*60*30})}function K(e){return y({queryKey:["category",e],queryFn:async()=>{if(!e)return null;const{data:t,error:r}=await f.from("categories").select("*").eq("slug",e).single();if(r&&r.code!=="PGRST116")throw r;return t},enabled:!!e,staleTime:1e3*60*30})}function b(e,t){return y({queryKey:_.userVotes(e,t),queryFn:async()=>{if(!e||t.length===0)return[];const{data:r,error:a}=await f.from("votes").select("*").eq("user_id",e).in("joke_id",t);if(a)throw a;return r},enabled:!!e&&t.length>0,staleTime:1e3*60})}function M(e,t){return y({queryKey:_.userFavorites(e,t),queryFn:async()=>{if(!e||t.length===0)return[];const{data:r,error:a}=await f.from("favorites").select("*").eq("user_id",e).in("joke_id",t);if(a)throw a;return r},enabled:!!e&&t.length>0,staleTime:1e3*60})}function C(e,t=0,r=15){return y({queryKey:["favorites",e,"all","paginated",t],queryFn:async()=>{if(!e)return{jokes:[],totalCount:0,totalPages:0};const a=t*r,{count:s}=await f.from("favorites").select("id",{count:"exact",head:!0}).eq("user_id",e),{data:u,error:l}=await f.from("favorites").select(`
          joke_id,
          jokes!inner(
            id,
            content,
            created_at,
            upvotes,
            downvotes,
            score,
            status,
            categories(name, slug),
            profiles!inner(username)
          )
        `).eq("user_id",e).eq("jokes.status","published").order("created_at",{ascending:!1}).range(a,a+r-1);if(l)throw l;return{jokes:(u==null?void 0:u.map(o=>({id:o.jokes.id,content:o.jokes.content,created_at:o.jokes.created_at,upvotes:o.jokes.upvotes,downvotes:o.jokes.downvotes,score:o.jokes.score,status:o.jokes.status,profiles:o.jokes.profiles,categories:o.jokes.categories,isFavorite:!0})))||[],totalCount:s||0,totalPages:Math.ceil((s||0)/r)}},enabled:!!e,staleTime:1e3*60*2})}function D(e,t={}){const{categoryId:r=null,sortBy:a="relevance",page:s=0}=t,u=15;return y({queryKey:_.searchResults(e,{categoryId:r,sortBy:a,page:s}),queryFn:async()=>{if(!e.trim())return{jokes:[],totalCount:0,totalPages:0};const l=s*u,{data:n,error:o}=await f.rpc("search_jokes",{search_query:e.trim(),p_category_id:r,p_limit:u,p_offset:l,p_order_by:a});if(o)throw console.error("Search error:",o),new Error("Search failed");const{data:i,error:d}=await f.rpc("count_search_results",{search_query:e.trim(),p_category_id:r});if(d)throw console.error("Count error:",d),new Error("Count failed");return{jokes:(n==null?void 0:n.map(c=>({id:c.id,content:c.content,status:c.status,author_id:c.author_id,category_id:c.category_id,slug:c.slug,upvotes:c.upvotes,downvotes:c.downvotes,score:c.score,created_at:c.created_at,updated_at:c.updated_at,profiles:c.author_username?{id:c.author_id,username:c.author_username,is_admin:!1,newsletter_consent:!1,created_at:c.created_at}:null,categories:c.category_name?{id:c.category_id,name:c.category_name,slug:c.category_slug,description_seo:null,created_at:c.created_at}:null,search_rank:c.rank})))||[],totalCount:i||0,totalPages:Math.ceil((i||0)/u)}},enabled:e.trim().length>0,staleTime:1e3*60})}function J(){const e=p();return m({mutationFn:async({jokeId:t,userId:r,voteType:a})=>{const{data:s}=await f.from("votes").select("*").eq("user_id",r).eq("joke_id",t).single();if(s){if(s.vote_type===a)return await f.from("votes").delete().eq("user_id",r).eq("joke_id",t),{action:"removed",jokeId:t,voteType:a};{const{data:u}=await f.from("votes").update({vote_type:a}).eq("user_id",r).eq("joke_id",t).select().single();return{action:"updated",jokeId:t,voteType:a,voteData:u}}}else{const{data:u}=await f.from("votes").insert({joke_id:t,user_id:r,vote_type:a}).select().single();return{action:"created",jokeId:t,voteType:a,voteData:u}}},onMutate:async({jokeId:t,voteType:r})=>{await e.cancelQueries({queryKey:_.jokes});const a=e.getQueriesData({queryKey:_.jokes});return e.setQueriesData({queryKey:_.jokes},s=>{var u;if(!s)return s;if(Array.isArray(s.jokes))return{...s,jokes:s.jokes.map(l=>{var n;if(l.id===t){const o=(n=l.userVote)==null?void 0:n.vote_type;let i=l.upvotes,d=l.downvotes,g={vote_type:r};return o===r?(r==="upvote"?i=Math.max(0,i-1):d=Math.max(0,d-1),g=null):o?r==="upvote"?(i=i+1,d=Math.max(0,d-1)):(i=Math.max(0,i-1),d=d+1):r==="upvote"?i=i+1:d=d+1,{...l,upvotes:i,downvotes:d,score:i-d,userVote:g}}return l})};if(s.id&&s.id===t){const l=(u=s.userVote)==null?void 0:u.vote_type;let n=s.upvotes,o=s.downvotes,i={vote_type:r};return l===r?(r==="upvote"?n=Math.max(0,n-1):o=Math.max(0,o-1),i=null):l?r==="upvote"?(n=n+1,o=Math.max(0,o-1)):(n=Math.max(0,n-1),o=o+1):r==="upvote"?n=n+1:o=o+1,{...s,upvotes:n,downvotes:o,score:n-o,userVote:i}}return s}),{previousJokes:a}},onError:(t,r,a)=>{a!=null&&a.previousJokes&&a.previousJokes.forEach(([s,u])=>{e.setQueryData(s,u)})},onSettled:()=>{e.invalidateQueries({queryKey:_.jokes})}})}function Q(){const e=p();return m({mutationFn:async({jokeId:t,userId:r})=>{const{data:a}=await f.from("favorites").select("*").eq("user_id",r).eq("joke_id",t).single();if(a)return await f.from("favorites").delete().eq("user_id",r).eq("joke_id",t),{action:"removed",jokeId:t,isFavorite:!1};{const{data:s}=await f.from("favorites").insert({joke_id:t,user_id:r}).select().single();return{action:"added",jokeId:t,isFavorite:!0,favoriteData:s}}},onMutate:async({jokeId:t})=>{await e.cancelQueries({queryKey:_.jokes});const r=e.getQueriesData({queryKey:_.jokes});return e.setQueriesData({queryKey:_.jokes},a=>a&&(Array.isArray(a.jokes)?{...a,jokes:a.jokes.map(s=>s.id===t?{...s,isFavorite:!s.isFavorite}:s)}:a.id&&a.id===t?{...a,isFavorite:!a.isFavorite}:a)),{previousJokes:r}},onError:(t,r,a)=>{a!=null&&a.previousJokes&&a.previousJokes.forEach(([s,u])=>{e.setQueryData(s,u)})},onSettled:()=>{e.invalidateQueries({queryKey:_.jokes}),e.invalidateQueries({queryKey:["favorites"]})}})}export{k as a,b,M as c,J as d,Q as e,C as f,j as g,K as h,D as i,F as u};
